# RUNTIME SNAPSHOT — WAVV
# This file should always contain the latest checkpoint bundle.
# Update it manually whenever we hit a meaningful checkpoint.

CURRENT THREAD

TikTok OAuth → Supabase connected_accounts write → Global Connected Accounts UI for /accounts

ACTIVE FILES

src/app/api/tiktok/oauth/start/route.ts

src/app/api/tiktok/oauth/callback/route.ts

src/app/accounts/page.tsx

(schema reference only, not editing) public.connected_accounts in Supabase

CHECKPOINT

Current goal
Get TikTok OAuth callback to successfully upsert into connected_accounts in prod.

Step just completed
Observed Supabase error: no unique or exclusion constraint matching the ON CONFLICT specification.

Files touched
None (this is purely a DB constraint mismatch with existing code).

APIs/routes involved
GET /api/tiktok/oauth/callback → Supabase connected_accounts upsert.

Env vars referenced
Same TikTok + Supabase envs as before; no changes required.

Assumptions

public.connected_accounts has a user_id column.

There are no duplicate (user_id, platform) rows yet.

Next step (plain English)
Add a unique constraint on (user_id, platform) in Supabase, then re-run the TikTok connect flow and confirm you see a connected TikTok account on /accounts.

TikTok/Supabase/Auth state summary
OAuth flow reaches callback and token exchange succeeds; failure is now only at the “upsert to connected_accounts” step due to missing unique constraint.

Direction Log
We’ve moved from “schema missing token columns” → “schema missing unique constraint for upsert.” Once constraint is added, we should finally get a clean round-trip and can then polish the Accounts UI + ADHD-friendly flows.